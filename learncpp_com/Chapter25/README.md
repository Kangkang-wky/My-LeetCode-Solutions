## 25.2 — 虚函数和多态

### 不要从构造函数或析构函数调用虚函数

这是另一个经常困扰毫无戒心的新程序员的陷阱。你不应该从构造函数或析构函数中调用虚函数。为什么？

请记住，创建 Derived 类时，会先构造 Base 部分。如果您要从 Base 构造函数调用虚拟函数，而该类的 Derived 部分甚至尚未创建，则无法调用该函数的 Derived 版本，因为没有 Derived 对象可供 Derived 函数使用。在 C++ 中，它将改为调用 Base 版本。

析构函数也存在类似的问题。如果你在基类析构函数中调用虚函数，它将始终解析为该函数的基类版本，因为该类的派生部分已被销毁。

- 最佳实践： 切勿从构造函数或析构函数中调用虚函数。

### 虚函数的缺点

既然大多数时候你都希望你的函数是虚拟的，那么为什么不把所有函数都设为虚拟的呢？答案是因为它效率低下——解析虚拟函数调用比解析常规函数调用花费的时间更长。

此外，为了使虚拟函数正常工作，编译器必须为具有虚拟函数的类的每个对象分配一个额外的指针。这给原本较小的对象增加了很大的开销。

### 我们应该把所有的析构函数都设为虚拟化的吗？

这是新程序员经常问的一个问题。如上例所示，如果基类析构函数未标记为虚拟，那么如果程序员稍后删除指向派生对象的基类指针，程序就有泄漏内存的风险。避免这种情况的一种方法是将所有析构函数标记为虚拟。但你应该这样做吗？

回答“是”很容易，这样以后您就可以使用任何类作为基类——但这样做会降低性能（向类的每个实例添加虚拟指针）。因此，您必须权衡成本和意图。

我们建议：如果某个类没有明确设计为基类，那么通常最好不要有虚拟成员和虚拟析构函数。该类仍可通过组合使用。如果某个类设计为基类和/或具有任何虚拟函数，那么它应该始终具有虚拟析构函数。

## 25.7 纯虚函数、抽象基类和接口类